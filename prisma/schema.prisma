// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Persona {
  id           String   @id @default(cuid())
  name         String
  description  String
  systemPrompt String
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  agents Agent[]

  @@index([isDefault])
}

model RoundTable {
  id                String   @id @default(cuid())
  topic             String
  agentCount        Int
  maxRounds         Int      @default(5)
  status            String   @default("active") // "active" | "paused" | "archived"
  selectedAgentIds  String?  // JSON array of selected persona IDs
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  agents         Agent[]
  rounds         Round[]
  moeVoteJob     MoeVoteJob?
  discussionJob  DiscussionJob?
}

model MoeVoteJob {
  id                              String   @id @default(cuid())
  status                          String   // "pending" | "running" | "completed" | "failed"
  question                        String
  includeDiscussionAgentsInVoting Boolean  @default(false)
  agentCount                      Int      @default(3)

  // References ephemeral round table
  roundTableId                    String   @unique
  roundTable                      RoundTable @relation(fields: [roundTableId], references: [id], onDelete: Cascade)

  // Progress tracking
  currentRound                    Int?
  currentPhase                    String?  // "discussion" | "voting" | "aggregating"

  // Results (JSON stringified)
  result                          String?
  error                           String?

  // Timestamps
  createdAt                       DateTime @default(now())
  startedAt                       DateTime?
  completedAt                     DateTime?

  @@index([status])
  @@index([createdAt])
}

model Agent {
  id           String  @id @default(cuid())
  roundTableId String
  personaId    String? // Optional reference to Persona
  name         String
  persona      String  // System prompt defining role/perspective
  order        Int     // Turn order (1, 2, 3...)

  roundTable RoundTable @relation(fields: [roundTableId], references: [id], onDelete: Cascade)
  personaRef Persona?   @relation(fields: [personaId], references: [id], onDelete: SetNull)
  messages   Message[]

  @@index([roundTableId])
  @@index([personaId])
}

model Round {
  id           String    @id @default(cuid())
  roundTableId String
  roundNumber  Int
  status       String    @default("in_progress") // "in_progress" | "completed"
  createdAt    DateTime  @default(now())
  completedAt  DateTime?

  roundTable RoundTable @relation(fields: [roundTableId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@index([roundTableId])
}

model Message {
  id        String   @id @default(cuid())
  roundId   String
  agentId   String
  content   String   // The agent's response
  toolCalls String?  // JSON array of web searches performed
  citations String?  // JSON array of {url, title, usedInContext} objects
  createdAt DateTime @default(now())

  round Round @relation(fields: [roundId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([roundId])
  @@index([agentId])
}

model SearchCache {
  id        String   @id @default(cuid())
  query     String   @unique
  results   String   // JSON string: Array of EnrichedSearchResult
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])  // For efficient cleanup
}

model DiscussionJob {
  id           String   @id @default(cuid())
  status       String   // "pending" | "running" | "completed" | "failed"
  topic        String
  agentCount   Int
  maxRounds    Int      @default(5)
  
  // References round table
  roundTableId String   @unique
  roundTable   RoundTable @relation(fields: [roundTableId], references: [id], onDelete: Cascade)
  
  // Progress tracking
  currentRound Int?
  currentPhase String?  // "discussion" | "completed"
  
  // Error tracking
  error        String?
  
  // Timestamps
  createdAt    DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  
  @@index([status])
  @@index([createdAt])
}
